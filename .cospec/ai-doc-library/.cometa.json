{"design":{"lastTaskId":"f7bf8e5a-c7e7-4e37-9db3-b573801e6a3f","lastCheckpointId":"cbddf2414d1fa069e020c424f683cdeee3ed034f","content":"# AI技术文档库设计文档\n\n## 1. 架构概述\n\n### 1.1 架构目标\n\n* **可扩展性**: 系统采用微服务架构，支持水平扩展，可根据文档量和访问量动态调整资源\n* **高可用性**: 系统设计为无状态服务，支持多实例部署，避免单点故障\n* **可维护性**: 模块化设计，各组件职责明确，便于维护和升级\n* **高性能**: 文档检索1秒内返回结果，文档更新1分钟内完成\n\n### 1.2 架构原则\n\n* **单一职责原则**: 每个服务只负责特定的功能领域\n* **开闭原则**: 对扩展开放，对修改关闭\n* **里氏替换原则**: 子类可以替换父类\n* **接口隔离原则**: 使用最小接口，避免接口污染\n* **依赖倒置原则**: 依赖抽象而不是具体实现\n\n## 2. 系统架构\n\n### 2.1 整体架构图\n\n```mermaid\ngraph TB\n    subgraph 前端层\n        A[Web管理界面]\n        B[MCP客户端]\n    end\n\n    subgraph 网关层\n        C[API网关]\n    end\n\n    subgraph 服务层\n        D[文档管理服务]\n        E[文档检索服务]\n        F[MCP服务]\n        G[用户管理服务]\n    end\n\n    subgraph 数据层\n        H[文档存储]\n        I[索引存储]\n        J[元数据存储]\n    end\n\n    subgraph 外部系统\n        K[CoStrict IDE]\n    end\n\n    A --> C\n    B --> C\n    C --> D\n    C --> E\n    C --> F\n    C --> G\n    D --> H\n    D --> J\n    E --> I\n    F --> E\n    K --> B\n```\n\n### 2.2 架构分层\n\n#### 2.2.1 表示层\n\n* **Web管理界面**: 基于Vue技术栈，提供文档上传、管理、系统监控等功能\n* **MCP客户端**: CoStrict插件中的客户端组件，负责与MCP服务通信\n\n#### 2.2.2 业务层\n\n* **微服务架构**: 将系统功能拆分为多个独立的服务\n* **服务拆分原则**: 按业务领域和功能边界进行拆分\n\n#### 2.2.3 数据层\n\n* **文档存储**: 使用文件系统存储原始文档，支持多种格式\n* **索引存储**: 使用Elasticsearch存储文档索引，支持高效检索\n* **元数据存储**: 使用PostgreSQL存储文档元数据和系统配置\n\n## 3. 服务设计\n\n### 3.1 服务拆分\n\n| 服务名称 | 职责 | 技术栈 | 数据库 |\n|----------|------|--------|--------|\n| 文档管理服务 | 负责文档上传、解析、版本管理 | Go | PostgreSQL, 文件系统 |\n| 文档检索服务 | 负责文档索引构建和检索 | Go | Elasticsearch |\n| MCP服务 | 实现MCP协议，与CoStrict插件通信 | Go | - |\n| 用户管理服务 | 负责用户认证和权限管理 | Go | PostgreSQL |\n\n### 3.2 服务间通信\n\n#### 3.2.1 同步通信\n\n* **协议**: REST/gRPC\n* **负载均衡**: 使用Nginx或Kubernetes Service进行负载均衡\n\n#### 3.2.2 异步通信\n\n* **消息队列**: 使用RabbitMQ或Kafka处理文档处理等耗时任务\n* **事件驱动架构**: 服务间通过事件进行解耦\n\n### 3.3 API设计\n\n#### 3.3.1 文档上传API\n\n* **URL**: `/api/v1/documents`\n\n* **Method**: POST\n* **描述**: 上传文档到系统\n* **请求参数**:\n\n  ```json\n  {\n    \"name\": \"string, 文档名称\",\n    \"type\": \"string, 文档类型\",\n    \"version\": \"string, 文档版本\",\n    \"tags\": \"array, 文档标签\",\n    \"file\": \"file, 文件内容\"\n  }\n  ```\n\n* **响应格式**:\n\n  ```json\n  {\n    \"code\": 200,\n    \"data\": {\n      \"id\": \"string, 文档ID\",\n      \"name\": \"string, 文档名称\",\n      \"status\": \"string, 处理状态\"\n    },\n    \"message\": \"成功\"\n  }\n  ```\n\n#### 3.3.2 文档检索API\n\n* **URL**: `/api/v1/search`\n\n* **Method**: GET\n* **描述**: 检索文档\n* **请求参数**:\n\n  ```json\n  {\n    \"query\": \"string, 搜索关键词\",\n    \"filters\": {\n      \"type\": \"string, 文档类型\",\n      \"version\": \"string, 文档版本\",\n      \"tags\": \"array, 文档标签\"\n    },\n    \"page\": \"number, 页码\",\n    \"size\": \"number, 每页大小\"\n  }\n  ```\n\n* **响应格式**:\n\n  ```json\n  {\n    \"code\": 200,\n    \"data\": {\n      \"total\": \"number, 总数\",\n      \"items\": [\n        {\n          \"id\": \"string, 文档ID\",\n          \"name\": \"string, 文档名称\",\n          \"snippet\": \"string, 内容片段\",\n          \"score\": \"number, 相关度得分\"\n        }\n      ]\n    },\n    \"message\": \"成功\"\n  }\n  ```\n\n#### 3.3.3 MCP服务API\n\n* **URL**: `/mcp`\n\n* **Method**: POST\n* **描述**: 处理MCP协议请求\n* **请求参数**: 遵循MCP协议规范\n* **响应格式**: 遵循MCP协议规范\n\n## 4. 数据架构\n\n### 4.1 数据存储策略\n\n* **文件系统**: 存储原始文档文件，支持多种格式\n* **Elasticsearch**: 存储文档索引和内容，支持全文检索\n* **PostgreSQL**: 存储文档元数据、用户信息、系统配置等结构化数据\n\n### 4.2 数据一致性\n\n* **强一致性场景**: 用户认证、权限控制等需要强一致性的场景\n* **最终一致性场景**: 文档索引更新、文档处理等可以接受最终一致性的场景\n\n### 4.3 数据模型\n\n#### 4.3.1 文档元数据模型\n\n```json\n{\n  \"id\": \"string, 唯一标识\",\n  \"name\": \"string, 文档名称\",\n  \"type\": \"string, 文档类型\",\n  \"version\": \"string, 文档版本\",\n  \"tags\": \"array, 文档标签\",\n  \"file_path\": \"string, 文件路径\",\n  \"file_size\": \"number, 文件大小\",\n  \"status\": \"string, 处理状态\",\n  \"created_at\": \"datetime, 创建时间\",\n  \"updated_at\": \"datetime, 更新时间\"\n}\n```\n\n#### 4.3.2 用户模型\n\n```json\n{\n  \"id\": \"string, 唯一标识\",\n  \"username\": \"string, 用户名\",\n  \"email\": \"string, 邮箱\",\n  \"role\": \"string, 用户角色\",\n  \"created_at\": \"datetime, 创建时间\",\n  \"updated_at\": \"datetime, 更新时间\"\n}\n```\n\n## 5. 文档处理流程\n\n### 5.1 文档上传流程\n\n```mermaid\nsequenceDiagram\n    participant U as 用户\n    participant W as Web前端\n    participant G as API网关\n    participant D as 文档管理服务\n    participant S as 文件存储\n    participant P as 文档处理器\n    participant I as 索引服务\n\n    U->>W: 上传文档\n    W->>G: 发送文档上传请求\n    G->>D: 转发请求\n    D->>S: 存储文件\n    D->>D: 保存元数据到DB\n    D->>P: 发送文档处理消息\n    P->>P: 解析文档内容\n    P->>I: 发送索引更新请求\n    I->>I: 更新索引\n    D->>W: 返回处理结果\n    W->>U: 显示上传结果\n```\n\n### 5.2 文档检索流程\n\n```mermaid\nsequenceDiagram\n    participant C as CoStrict\n    participant M as MCP客户端\n    participant G as API网关\n    participant F as MCP服务\n    participant S as 文档检索服务\n    participant I as 索引服务\n\n    C->>M: 发送检索请求\n    M->>G: 发送MCP请求\n    G->>F: 转发请求\n    F->>S: 发送检索请求\n    S->>I: 执行检索\n    I->>S: 返回检索结果\n    S->>F: 返回检索结果\n    F->>G: 返回MCP响应\n    G->>M: 返回响应\n    M->>C: 返回检索结果\n```\n\n## 6. 系统扩展性设计\n\n### 6.1 服务扩展性\n\n* **水平扩展**: 通过增加服务实例数量来提升系统处理能力\n* **服务拆分**: 按业务领域和功能边界进行服务拆分，支持独立扩展\n\n### 6.2 存储扩展性\n\n* **存储策略**: 支持多种存储策略，可根据需求选择本地存储或分布式存储\n* **数据分片**: 支持数据分片存储，提高数据处理能力\n\n## 7. 关键功能设计\n\n### 7.1 AI友好格式设计\n\n#### 7.1.1 文档结构化处理\n\n系统将上传的文档转换为AI友好的结构化格式，包括：\n\n* **内容分段**: 将文档内容按逻辑划分为段落，每个段落包含明确的主题和内容\n* **代码示例提取**: 从文档中提取代码示例，并标注语言、用途等信息\n* **语义标注**: 为文档内容添加语义标注，如概念、定义、步骤、示例等\n* **关联关系**: 建立文档内容间的关联关系，形成知识图谱\n\n#### 7.1.2 LLM优化格式\n\n* **上下文优化**: 针对LLM的上下文限制，对文档内容进行优化，确保在有限上下文中提供最有价值的信息\n* **信息密度平衡**: 平衡信息密度和可理解性，避免信息过载\n* **多粒度表示**: 提供不同粒度的文档表示，从概览到详细内容，支持按需获取\n\n### 7.2 文档解析器设计\n\n#### 7.2.1 多格式支持\n\n系统支持解析多种文档格式：\n\n* **Markdown**: 直接解析为结构化内容\n* **PDF**: 使用PDF解析库提取文本内容和结构\n* **DOCX**: 使用Office文档解析库提取内容和格式\n* **Swagger/OpenAPI**: 解析API文档，提取接口定义和示例\n* **Java Doc**: 解析Java文档注释，提取API说明\n\n#### 7.2.2 解析流程\n\n```mermaid\nsequenceDiagram\n    participant F as 文件存储\n    participant P as 文档解析器\n    participant S as 结构化存储\n    participant I as 索引服务\n\n    F->>P: 提供待解析文件\n    P->>P: 识别文件类型\n    P->>P: 选择对应解析器\n    P->>P: 执行解析\n    P->>P: 生成结构化内容\n    P->>S: 保存结构化内容\n    P->>I: 发送索引更新请求\n    I->>I: 更新索引\n```\n\n### 7.3 MCP协议实现\n\n#### 7.3.1 MCP服务架构\n\n```mermaid\ngraph LR\n    subgraph MCP服务\n        A[协议解析层]\n        B[请求处理层]\n        C[文档检索层]\n        D[响应格式化层]\n    end\n    \n    A --> B\n    B --> C\n    C --> D\n```\n\n#### 7.3.2 MCP配置接口\n\n系统提供与Context7兼容的MCP配置接口：\n\n```json\n{\n  \"mcpServers\": {\n    \"ai-doc-library\": {\n      \"type\": \"streamable-http\",\n      \"url\": \"http://ai-doc-library:8080/mcp\",\n      \"headers\": {\n        \"API_KEY\": \"YOUR_API_KEY\"\n      }\n    }\n  }\n}\n```\n\n#### 7.3.3 MCP请求处理流程\n\n1. 接收MCP协议请求\n2. 解析请求参数，包括查询内容、过滤条件等\n3. 调用文档检索服务获取相关文档\n4. 对检索结果进行格式化和优化\n5. 按MCP协议格式返回响应\n\n### 7.4 文档版本管理\n\n#### 7.4.1 版本控制策略\n\n* **语义化版本**: 采用语义化版本号（主版本.次版本.修订版本）\n* **版本关联**: 同一文档的不同版本间建立关联关系\n* **默认版本**: 支持设置默认版本，未指定版本时使用默认版本\n\n#### 7.4.2 版本存储结构\n\n```\n文档存储/\n├── 文档ID/\n│   ├── v1.0.0/\n│   │   ├── 原始文件\n│   │   └── 解析结果\n│   ├── v1.1.0/\n│   │   ├── 原始文件\n│   │   └── 解析结果\n│   └── current -> v1.1.0 (符号链接)\n```\n\n#### 7.4.3 版本检索机制\n\n* **精确版本匹配**: 检索指定版本的文档\n* **最新版本检索**: 检索文档的最新版本\n* **版本范围检索**: 检索指定版本范围内的文档\n\n### 7.5 用户管理设计\n\n#### 7.5.1 用户认证机制\n\n* **JWT认证**: 使用JWT进行用户身份认证\n* **API密钥认证**: 支持API密钥认证，用于MCP服务调用\n* **多因素认证**: 支持多因素认证，提高安全性\n\n#### 7.5.2 权限控制模型\n\n```mermaid\ngraph TB\n    A[用户] --> B[角色]\n    B --> C[权限]\n    C --> D[资源]\n    \n    subgraph 角色定义\n        B1[管理员]\n        B2[文档管理员]\n        B3[普通用户]\n    end\n    \n    subgraph 权限类型\n        C1[读取权限]\n        C2[写入权限]\n        C3[删除权限]\n        C4[管理权限]\n    end\n    \n    subgraph 资源类型\n        D1[文档]\n        D2[系统配置]\n        D3[用户管理]\n    end\n    \n    B --> B1\n    B --> B2\n    B --> B3\n    C --> C1\n    C --> C2\n    C --> C3\n    C --> C4\n    D --> D1\n    D --> D2\n    D --> D3\n```\n\n#### 7.5.3 用户数据模型\n\n```json\n{\n  \"id\": \"string, 用户唯一标识\",\n  \"username\": \"string, 用户名\",\n  \"email\": \"string, 电子邮箱\",\n  \"password_hash\": \"string, 密码哈希\",\n  \"role\": \"string, 用户角色\",\n  \"api_keys\": [\n    {\n      \"key\": \"string, API密钥\",\n      \"name\": \"string, 密钥名称\",\n      \"created_at\": \"datetime, 创建时间\",\n      \"expires_at\": \"datetime, 过期时间\",\n      \"last_used\": \"datetime, 最后使用时间\"\n    }\n  ],\n  \"created_at\": \"datetime, 创建时间\",\n  \"updated_at\": \"datetime, 更新时间\"\n}\n```\n"},"requirements":{"lastTaskId":"f7bf8e5a-c7e7-4e37-9db3-b573801e6a3f","lastCheckpointId":"cbddf2414d1fa069e020c424f683cdeee3ed034f","content":"# AI技术文档库需求文档\n\n## 1. 项目概述\n\n### 1.1 项目背景\nContext7是一个开源平台，能够从官方源（如文档站点、GitHub仓库）实时提取最新的、特定版本的文档和代码示例，并通过MCP协议将其注入到AI模型的上下文中。这使得AI编程助手能够生成更准确、实用的代码，显著减少\"幻觉\"现象。\n\nCoStrict作为一款AI编程IDE，主要面向企业私有化场景，很多情况下是内网部署，无法直接访问互联网。对于内网用户，无法使用Context7，如果能实现一个类似Context7效果的系统，支持内网部署使用，将有助于提高CoStrict的代码生成能力。\n\n### 1.2 项目目标\n实现一个类似Context7的技术文档库，能进行企业私有化部署，通过让CoStrict获取相关技术文档或代码示例，提高代码生成精准性。\n\n## 2. 功能需求\n\n### 2.1 核心功能\n\n#### 2.1.1 文档管理\n- **文档上传**：支持手动上传多种格式文档，包括docx、pdf、markdown、swagger、openapi、java doc等常见文档格式\n- **文档解析**：能够解析各种格式的文档，提取有用信息\n- **文档版本管理**：支持按库的具体版本过滤文档，确保提供的信息与当前使用的技术栈完全一致\n- **文档存储**：能够高效存储大量文档数据\n\n#### 2.1.2 文档检索\n- **实时文档检索**：通过MCP协议，能够实时从文档库获取文档和代码示例\n- **智能搜索**：支持关键词搜索、语义搜索等多种检索方式\n- **快速响应**：文档检索应在1秒内返回结果\n\n#### 2.1.3 AI友好格式\n- **LLM优化格式**：生成专为LLM设计的文档格式，便于模型理解和使用\n- **上下文注入**：通过MCP协议将相关文档注入到AI模型的上下文中\n\n#### 2.1.4 MCP协议支持\n- **MCP服务器**：实现MCP服务器功能，与CoStrict插件集成\n- **API接口**：提供标准的API接口，支持CoStrict插件配置\n- **认证机制**：支持API密钥认证，确保安全性\n\n### 2.2 系统管理功能\n\n#### 2.2.1 用户管理\n- **用户认证**：支持用户登录认证\n- **权限管理**：支持不同级别的用户权限控制\n\n#### 2.2.2 系统监控\n- **性能监控**：监控系统运行状态和性能指标\n- **日志管理**：记录系统运行日志，便于问题排查\n\n## 3. 非功能需求\n\n### 3.1 性能需求\n- **文档更新**：1分钟内完成一个库的最新版本文档更新，比如React最新版本的库\n- **文档检索**：1秒内返回结果\n- **并发处理**：支持多用户同时访问和检索文档\n\n### 3.2 可扩展性需求\n- **服务伸缩性**：服务具备可伸缩性，可根据系统压力进行横向扩展\n- **存储扩展性**：存储具备可扩展性，优先使用本地存储，但后期可扩展到分布式\n\n### 3.3 可靠性需求\n- **故障恢复**：系统具有相关可靠性措施，能够故障恢复\n- **数据备份**：支持数据备份和恢复机制\n- **高可用性**：系统应具备高可用性，避免单点故障\n\n### 3.4 部署需求\n- **容器化部署**：部署方式支持容器化，docker-compose、k8s\n- **私有化部署**：支持企业内网环境下的私有化部署\n\n### 3.5 可维护性需求\n- **代码质量**：代码质量优秀，符合SOLID、Clean Code、KISS、DRY等相关原则\n- **模块化设计**：系统采用模块化设计，便于维护和升级\n- **文档完善**：提供完善的系统文档和API文档\n\n### 3.6 可测试性需求\n- **单元测试**：需编写单元测试与集成测试，覆盖率≥80%\n- **端到端测试**：需要进行端到端测试验证，确保功能完全可用\n- **性能测试**：进行性能测试，确保系统满足性能要求\n\n## 4. 技术需求\n\n### 4.1 开发环境\n- **IDE**：vscode 最新版 + CoStrict 最新版（插件市场有）\n- **开发语言**：后端语言使用golang，前端使用Vue或React均可\n\n### 4.2 开发规范\n- **代码规范**：全程使用CoStrict AI编程，代码须符合项目现有规范\n- **代码质量**：代码质量优秀，符合SOLID、Clean Code、KISS、DRY等相关原则\n\n### 4.3 测试要求\n- **单元测试**：执行`make test`无失败，增量代码测试覆盖率≥80%\n- **端到端测试**：服务端部署→增加技术文档库→CoStrict插件配置mcp→对话框发起提问。确保mcp功能正常，能检索到相关文档\n- **效果测试**：构造测试用例，利用CoStrict实现一些需求，比如使用某种技术实现某个功能。在使用和使用技术文档库的场景下，能看出明显的效果提升\n- **性能测试**：文档更新，1min内完成一个库的最新版本文档更新；文档检索，1s内返回结果\n\n## 5. 交付内容\n\n### 5.1 源码\n- 项目完整源码\n\n### 5.2 文档\n- 本方案的设计文档\n\n### 5.3 测试报告\n- 效果测试报告（图文）\n- 性能测试报告（图文）\n\n### 5.4 演示材料\n- 端到端功能演示视频（参考端到端测试流程）"},"tasks":{"lastTaskId":"cf2f6612-21fc-411b-9a27-13b022a4138e","lastCheckpointId":"ba194673924f27a8e40a7deff7c490ee90b15fc4","content":"# 任务清单 - AI技术文档库\n\n- [x] 1. 实现【文档管理】功能子需求\n  - 实现文档上传API接口，支持多种格式文档上传\n  - 实现文档解析功能，支持docx、pdf、markdown、swagger、openapi、java doc等格式\n  - 实现文档元数据管理功能\n  - 实现文档存储功能，支持高效存储大量文档数据\n  - 实现文档版本管理功能，支持按库的具体版本过滤文档\n  - 实现文档管理前端页面\n  - 确保子需求可独立运行\n  - _需求：[2.1.1]_\n  - _测试：[是]_\n  - _测试详情：[处理器层测试 - internal/handler/document_handler_test.go，包含文档上传、获取、列表、版本管理和删除功能的测试用例；仓库层测试 - internal/repository/document_repository_test.go，包含文档CRUD操作的测试用例；路由层测试 - internal/router/router_test.go，包含API路由配置和CORS中间件的测试用例]_\n\n- [x] 2. 实现【文档检索】功能子需求\n  - 实现文档索引构建功能\n  - 实现关键词搜索功能\n  - 实现语义搜索功能\n  - 实现文档检索API接口，支持实时检索\n  - 实现文档检索前端页面\n  - 确保检索响应时间在1秒内\n  - 确保子需求可独立运行\n  - _需求：[2.1.2]_\n  - _测试：[是]_\n\n- [x] 3. 实现【AI友好格式】功能子需求\n  - 实现文档结构化处理功能，包括内容分段、代码示例提取、语义标注\n  - 实现LLM优化格式生成功能\n  - 实现多粒度文档表示功能\n  - 实现上下文注入功能\n  - 确保子需求可独立运行\n  - _需求：[2.1.3]_\n  - _测试：[否]_\n\n- [x] 4. 实现【MCP协议支持】功能子需求\n  - 实现MCP服务器功能\n  - 实现MCP协议解析层\n  - 实现MCP请求处理层\n  - 实现MCP响应格式化层\n  - 实现API密钥认证机制\n  - 实现MCP配置接口\n  - 确保子需求可独立运行\n  - _需求：[2.1.4]_\n  - _测试：[是]_\n\n- [x] 5. 实现【用户管理】功能子需求\n  - 实现用户认证功能，支持JWT认证\n  - 实现用户注册功能\n  - 实现用户登录功能\n  - 实现用户权限控制功能\n  - 实现API密钥管理功能\n  - 实现用户管理前端页面\n  - 确保子需求可独立运行\n  - _需求：[2.2.1]_\n  - _测试：[是]_\n\n- [x] 6. 实现【系统监控】功能子需求（已完成：实现了性能监控、日志管理、系统状态展示、前端页面，修复了性能报告API和数据渲染问题）\n  - 实现性能监控功能\n  - 实现日志管理功能\n  - 实现系统状态展示功能\n  - 实现系统监控前端页面\n  - 确保子需求可独立运行\n  - _需求：[2.2.2]_\n  - _测试：[否]_\n\n- [x] 7. 实现【API网关】功能子需求\n  - 实现请求路由功能\n  - 实现负载均衡功能\n  - 实现请求认证功能\n  - 确保子需求可独立运行\n  - _需求：[3.1.3]_\n  - _测试：[是]_\n\n- [ ] 8. 实现【文档处理性能优化】功能子需求\n  - 实现文档处理流程优化功能\n  - 实现文档更新性能优化功能\n  - 实现并发处理功能\n  - 确保子需求可独立运行\n  - _需求：[3.1.1, 3.1.3]_\n  - _测试：[否]_\n\n- [ ] 9. 实现【系统扩展性】功能子需求\n  - 实现服务横向扩展功能\n  - 实现存储扩展功能，支持从本地存储扩展到分布式存储\n  - 确保子需求可独立运行\n  - _需求：[3.2.1, 3.2.2]_\n  - _测试：[否]_\n\n- [ ] 10. 实现【系统可靠性】功能子需求\n  - 实现故障恢复功能\n  - 实现数据备份和恢复机制\n  - 实现高可用性部署，避免单点故障\n  - 确保子需求可独立运行\n  - _需求：[3.3.1, 3.3.2, 3.3.3]_\n  - _测试：[否]_\n\n- [ ] 11. 实现【系统部署配置】功能子需求\n  - 实现Docker容器化配置\n  - 实现Docker Compose配置文件\n  - 实现Kubernetes配置文件\n  - 实现私有化部署配置\n  - 确保子需求可独立运行\n  - _需求：[3.4.1, 3.4.2]_\n  - _测试：[否]_"},"version":"1.0.0","lastModified":"2026-01-03T13:33:59.518Z"}